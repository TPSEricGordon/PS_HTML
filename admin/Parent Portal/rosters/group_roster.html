<!DOCTYPE html>
<html>
<head>
	<title>Temp Parent Search</title>

    <!-- required scripts -->
	~[wc:commonscripts]
    <!-- Required style sheets: screen.css, and print.css -->
	<link href="/images/css/screen.css" rel="stylesheet" media="screen">
	<link href="/images/css/print.css" rel="stylesheet" media="print">
</head>
<body>
	~[wc:admin_header_css]

    <!-- breadcrumb start -->
    <a href="/admin/home.html" target="_top">~[text:psx.html.admin_district.misc-district.start_page]</a>
		&gt; <a href="/admin/parent_coaches/home.html" target="_top"> Parent Portal </a>&gt;
	&nbsp; Parent Search
    <!-- breadcrumb end -->

    <!-- start of main menu and content -->
	~[wc:admin_navigation_css]

    <!-- Start of Page -->
	<h1>Parent Search</h1>

	<div class="box-round">
		<fieldset>
			<table class="grid" id="groups">
				 <thead>
						<tr style="border:1px solid grey;">
							 <th class="bold" style="width:10px;text-align: center">Family ID</th>
							 <th class="bold" style="width:20px">Parents</th>
							 <th class="bold" style="width:65px">Students</th>
							 <th class="bold" style="width:20px">GROUP_ID</th>
							 <th class="bold" style="width:20px">GROUP_ID2</th>
							 <th class="bold" style="width:75px">Parent Groups</th>
						</tr>
				 </thead>
				 <tbody>
						~[tlist_sql;
						SELECT
							PARENTS.FAMILY_ID,
							PARENTS.parent_names,
							STUDENTS.student_names,
							PE1.GROUP_ID AS Group_ID1,
							PE2.GROUP_ID AS Group_ID2,
							CASE WHEN PE1.PARENT_1_GROUP IS NULL AND PE2.PARENT_2_GROUP IS NULL THEN 'No Enrollments'
								 WHEN PE1.PARENT_1_GROUP IS NULL AND PE2.PARENT_2_GROUP IS NOT NULL THEN PE2.PARENT_2_GROUP
								WHEN PE1.PARENT_1_GROUP IS NOT NULL AND PE2.PARENT_2_GROUP IS NULL THEN PE1.PARENT_1_GROUP
								WHEN PE1.PARENT_1_GROUP IS NOT NULL AND PE2.PARENT_2_GROUP IS NOT NULL THEN
								PE1.PARENT_1_GROUP ||' & ' || PE2.PARENT_2_GROUP END AS parent_groups
						FROM (
							SELECT
								FAMILY_ID,
								LISTAGG( Parent_Name, ' and ' ) WITHIN GROUP (ORDER BY Parent_Name) AS parent_names,
								LISTAGG( ID, ',' ) WITHIN GROUP (ORDER BY ID) AS P_IDS
							FROM (
								SELECT FAMILY_ID, FIRST_NAME || ' ' || LAST_NAME AS Parent_Name,  Parent_Id, ID
								FROM PS.U_PARENT_DATA
								)
							GROUP BY FAMILY_ID
							) PARENTS
						JOIN (
							SELECT
								FAMILY_IDENT,
								LISTAGG( Student_Name, ' and ' ) WITHIN GROUP (ORDER BY Student_Name) AS student_names,
								LISTAGG( STUDENT_NUMBER, ',' ) WITHIN GROUP (ORDER BY STUDENT_NUMBER) AS S_IDS
							FROM (
								SELECT S.FAMILY_IDENT, S.FIRST_NAME || ' ' || S.LAST_NAME AS Student_Name, S.STUDENT_NUMBER
								FROM PS.STUDENTS S
								WHERE S.ENROLL_STATUS = 0
								)
							GROUP BY FAMILY_IDENT
							) STUDENTS

							ON PARENTS.FAMILY_ID = STUDENTS.FAMILY_IDENT

						LEFT JOIN
							(
							SELECT U_PARENT_DATAID, PG.CODE AS PARENT_1_GROUP, PE.GROUP_ID
							FROM PS.U_PARENT_ENROLLMENTS PE
								JOIN PS.U_PARENT_GROUPS PG
									ON PE.GROUP_ID = PG.ID
							WHERE ENROLL_STATUS=1
							) PE1
							ON PE1.U_PARENT_DATAID = REGEXP_SUBSTR ( PARENTS.P_IDS , chr(91)||'^,'||chr(93)||'+', 1, 1)

						LEFT JOIN (
							SELECT U_PARENT_DATAID, CODE AS PARENT_2_GROUP, PE.GROUP_ID
							FROM PS.U_PARENT_ENROLLMENTS PE
								JOIN PS.U_PARENT_GROUPS PG
									ON PE.GROUP_ID = PG.ID
							WHERE ENROLL_STATUS=1
							) PE2
							ON PE2.U_PARENT_DATAID = REGEXP_SUBSTR ( PARENTS.P_IDS , chr(91)||'^,'||chr(93)||'+', 1, 2)

						]
						<tr>
							<td> ~(FAMILY_ID)</td>
							 <td>~(parent_names)</td>
							 <td>~(student_names)</td>
							 <td>~(Group_ID1)</td>
							 <td>~(Group_ID2)</td>
							 <td>~(parent_groups)</td>
						 </tr>
						[/tlist_sql]
						</fieldset>
				 </tbody>
			</table>

	  </fieldset>
	</div>
</body>
</html>
