[
	~[tlist_sql;
		SELECT
				parents.ID,
				parents.FAMILY_ID,
				parents.NAME,
				CONCAT('/admin/contacts/edit.html#?contactid=',parents.ID) LINK,
				--parents.PHONE,
				PHONENUMBERASENTERED AS PHONE,
				--parents.CURRENT_GROUP,
				CASE WHEN parent_group.CODE IS NULL THEN 'None' ELSE parent_group.CODE END AS CURRENT_GROUP,
				'/admin/parent_coaches/enrollment/parent_enrollments.html?id='||parents.ID||'&enroll_id='||parent_group.ID AS ENROLL_LINK,
				--parents.ENROLL_LINK,
				parents.STUDENTS,
				parents.COHORTS,
				use.FIRST_NAME AS COACH_NAME,
				use.DCID
			FROM (
				SELECT
					P.ID,
					MAX(S.FAMILY_IDENT)  AS FAMILY_ID,
					P.FIRSTNAME || ' ' || P.LASTNAME AS NAME,
					LISTAGG(S.FIRST_NAME, ' and ') WITHIN GROUP (ORDER BY S.FIRST_NAME) AS STUDENTS,
					LISTAGG(SE.COHORT, ' and ') WITHIN GROUP (ORDER BY S.FIRST_NAME) AS COHORTS,
					MAX(SE.PARENT_COACH_EMAIL) AS COACH_EMAIL
				FROM PS.PERSON P
					JOIN PS.STUDENTCONTACTASSOC SCA
						ON p.ID = SCA.PERSONID
					JOIN PS.STUDENTCONTACTDETAIL SCD
						ON SCA.STUDENTCONTACTASSOCID = SCD.STUDENTCONTACTASSOCID
					LEFT JOIN PS.STUDENTS S
						ON SCA.STUDENTDCID = S.DCID
					JOIN PS.U_DEF_EXT_STUDENTS SE
						ON SE.STUDENTSDCID = S.DCID
				WHERE scd.ISACTIVE=1
				AND (scd.LIVESWITHFLG = 1 OR SCD.ISCUSTODIAL=1)
				GROUP BY P.ID, P.FIRSTNAME, P.LASTNAME
				) parents
			LEFT JOIN PS.U_DEF_EXT_PERSON PE
				ON parents.ID = PE.PERSONID

			 LEFT JOIN (
			 	SELECT PHONENUMBERASENTERED, PERSONID
			 	FROM PS.PERSONPHONENUMBERASSOC PHONEA
			 	WHERE PHONEA.PHONENUMBERPRIORITYORDER=1
			 	) phones
			 	ON phones.PERSONID = parents.ID

			LEFT JOIN PS.USERS use
						ON parents.COACH_EMAIL = use.EMAIL_ADDR
			LEFT JOIN (
				SELECT PERSONID, CODE, PGE.ID
				FROM (
				SELECT ID,
					ROW_NUMBER() OVER (PARTITION BY PERSONID ORDER BY WHENCREATED DESC) RECENCY,
					PERSONID, GROUP_ID, ENROLL_STATUS, WHENCREATED
				 FROM PS.U_PARENT_CIRCLE_ENROLLMENTS
				 WHERE ENROLL_STATUS=1
				 ) PGE
				 	JOIN PS.U_PARENT_GROUPS G
					ON PGE.GROUP_ID = G.ID
				WHERE RECENCY = 1
				) parent_group
				ON parent_group.PERSONID = parents.ID
WHERE use.DCID=~(gpv.coach_id)

	]

		{"PARENT_ID":"~(PARENT_ID)",
			"FAMILY_ID":"~(FAMILY_ID)",
			"NAME":"~(NAME)",
			"LINK":"~(LINK)",
			"PHONE":"~(PHONE)",
			"CURRENT_GROUP":"~(CURRENT_GROUP)",
			"ENROLL_LINK":"~(ENROLL_LINK)",
			"STUDENT":"~(STUDENT)",
			"COHORT":"~(COHORT)",
			"COACH_NAME":"~(COACH_NAME)"
		},
	[/tlist_sql]
{}]
